#!/usr/bin/env node

'use strict';

Error.stackTraceLimit = Infinity;

var noop      = require('es5-ext/lib/Function/noop')
  , some      = require('es5-ext/lib/Object/some')
  , clc       = require('cli-color')
  , lintPaths = require('../lib/lint-paths')
  , getLinter = require('../lib/_get-linter')

  , optimist = require('optimist')
	.usage("usage: $0 [options] <linter> [<paths>]", {
		cache: {
			boolean: true,
			default: true,
			description: "Cache generated reports (for faster retrieval later)"
		},
		color: {
			boolean: true,
			default: true,
			description: "Colorize output"
		},
		depth: {
			default: Infinity,
			description: "How deeply to recurse into directories (default: Infinity)"
		},
		help: {
			boolean: true,
			desription: "Show this help"
		},
		ignoreRules: {
			default: 'git',
			description: "Obey ignore rules up to given mode "
				+ "(Currently just 'git' is supported)"
		},
		stream: {
			boolean: true,
			default: true,
			description: "Whether to generate reports on the go "
				+ "(while file system is scanned)"
		},
		watch: {
			boolean: true,
			description: "Live console mode, updated on file and settings changes"
		}
	}).demand(1)
  , options = optimist.argv
  , linter, paths, reporter;

if (options.help) {
	console.log(optimist.help());
	process.exit(0);
}

linter = getLinter(options._[0]);
paths = options._.slice(1);

delete options._;
delete options.$0;

if (!paths.length) {
	paths.push('.');
}

if (options.watch) {
	// Keep process persistent
	setTimeout(noop, 1e9);
}

if (options.watch && (clc.width > 10) && (clc.height > 10) &&
		(process.platform !== 'win32')) {
	reporter = require('../lib/reporters/console-watch');
} else if (options.stream) {
	reporter = require('../lib/reporters/console-stream');
} else {
	reporter = require('../lib/reporters/console');
}

reporter = reporter(lintPaths(linter, paths, options), options);
reporter.end();
process.on('exit', function () {
	reporter.end(function (data) {
		process.exit(some(data, function (report) {
			return report.length;
		}) ? 1 : 0);
	});
});
